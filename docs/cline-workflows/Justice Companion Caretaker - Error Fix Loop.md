# Justice Companion Caretaker - Error Fix Loop

## Purpose
Automatically detect, analyze, and fix errors found by caretaker workflows. Uses iterative repair with max 5 attempts before escalating to human intervention.

## Workflow Steps

### 1. Error Detection

#### Monitor History for Errors
```bash
# Find recent errors in history
jq 'select(.type == "error" or .type == "quality_gate" and .data.overall_status == "FAIL")' .localclaude/history.jsonl | tail -10
```

**Error Sources:**
- Quality Gate Check failures
- Daily Status Sweep issues
- Build failures
- Test failures
- Security vulnerabilities
- Type errors
- Lint errors

#### Parse Error Details
Extract from history entry:
```json
{
  "timestamp": "2025-11-10T10:00:00Z",
  "type": "quality_gate",
  "data": {
    "overall_status": "FAIL",
    "results": {
      "lint": { "status": "fail", "errors": 5 },
      "typecheck": { "status": "fail", "errors": 3 },
      "unit_tests": { "status": "fail", "failed": 2 }
    }
  }
}
```

**Categorize errors:**
- **Auto-fixable:** Lint errors, format issues, simple type errors
- **Semi-auto:** Test failures (can attempt fix)
- **Manual:** Complex logic errors, architecture issues
- **Security:** Dependency vulnerabilities (auto-update if safe)

### 2. Prioritize Errors

**Priority Matrix:**
```
P0 (Fix Immediately):
- Build failures (blocks development)
- Critical security vulnerabilities (CVSS >9.0)
- Authentication broken
- Data corruption risk

P1 (Fix Within 1 Hour):
- High security vulnerabilities (CVSS 7.0-8.9)
- Test failures blocking PR merge
- Type errors blocking build

P2 (Fix Within 1 Day):
- Lint errors
- Moderate security vulnerabilities
- Flaky tests
- Performance regressions

P3 (Backlog):
- Warnings
- Low security vulnerabilities
- Minor code quality issues
```

### 3. Automated Fix Attempts

#### Fix Loop Algorithm
```
FOR each error IN prioritized_errors:
  attempt_count = 0
  max_attempts = 5

  WHILE attempt_count < max_attempts AND error_not_fixed:
    attempt_count += 1

    fix_result = apply_fix_strategy(error)

    IF fix_result.success:
      verify_result = run_verification_tests()

      IF verify_result.all_pass:
        log_success(error, attempt_count)
        BREAK
      ELSE:
        rollback_changes()

    IF attempt_count >= max_attempts:
      escalate_to_human(error)
```

#### Fix Strategy by Error Type

**Lint Errors (Auto-Fix):**
```bash
# Strategy: Use ESLint auto-fix
pnpm lint:fix

# Verify fix
pnpm lint

# If successful
git add .
git commit -m "chore: auto-fix lint errors

- Fixed via ESLint --fix
- All rules now passing

ğŸ¤– Generated by Cline Caretaker (Error Fix Loop)"
```

**Type Errors (Semi-Auto):**
```bash
# Strategy 1: Add missing type annotations
# Analyze error message
tsc --noEmit 2>&1 | grep "error TS"

# Common fixes:
# - Add 'as const' for literal types
# - Add explicit return types
# - Import missing types
# - Add @ts-expect-error with comment (last resort)

# Strategy 2: Use TypeScript quick fixes
# (Requires manual intervention via IDE)

# Verify fix
pnpm type-check
```

**Test Failures (Context-Aware):**
```bash
# Strategy: Analyze test failure reason
pnpm test --reporter=verbose 2>&1 | tee .localclaude/test-failure.log

# Common failure patterns:
# 1. Timeout â†’ Increase timeout
# 2. Snapshot mismatch â†’ Update snapshot (if intentional change)
# 3. Assertion failure â†’ Analyze expected vs actual
# 4. Mock not working â†’ Check mock setup

# Attempt fix based on pattern
case $FAILURE_PATTERN in
  "timeout")
    # Increase test timeout
    sed -i 's/timeout: [0-9]*/timeout: 30000/' vitest.config.ts
    ;;
  "snapshot")
    # Update snapshots
    pnpm test -- -u
    ;;
  "mock")
    # Check mock imports and setup
    # (Manual review required)
    ;;
esac

# Verify fix
pnpm test
```

**Build Failures (Critical):**
```bash
# Strategy: Identify build error type
pnpm build 2>&1 | tee .localclaude/build-failure.log

# Common issues:
# 1. Missing import extensions â†’ Run fix-imports-simple.mjs
# 2. Module not found â†’ Check package.json dependencies
# 3. Vite config error â†’ Verify vite.config.ts syntax
# 4. TypeScript errors â†’ Run type-check first

# Attempt fix
case $BUILD_ERROR in
  "Cannot find module")
    # Add .ts extensions
    node fix-imports-simple.mjs
    ;;
  "Module not found")
    # Install missing dependency
    pnpm install
    ;;
  *)
    # Escalate to human
    escalate_to_human "Build failure: $BUILD_ERROR"
    ;;
esac

# Verify fix
pnpm build
```

**Security Vulnerabilities (Auto-Update):**
```bash
# Strategy: Update vulnerable packages
pnpm audit --json > .localclaude/audit-report.json

# Parse vulnerable packages
VULN_PACKAGES=$(jq -r '.vulnerabilities | to_entries | map(select(.value.severity == "high" or .value.severity == "critical")) | .[].key' .localclaude/audit-report.json)

# Attempt auto-fix
for package in $VULN_PACKAGES; do
  echo "Updating $package..."

  # Check if fix available
  FIX_AVAILABLE=$(jq -r ".vulnerabilities.\"$package\".fixAvailable" .localclaude/audit-report.json)

  if [ "$FIX_AVAILABLE" != "false" ]; then
    # Update to fixed version
    pnpm update "$package"

    # Run tests to verify no breaking changes
    pnpm test

    if [ $? -eq 0 ]; then
      echo "âœ… $package updated successfully"
    else
      # Rollback
      git checkout pnpm-lock.yaml package.json
      echo "âŒ $package update broke tests, rolled back"
    fi
  else
    echo "âš ï¸ No fix available for $package"
    # Create issue for manual intervention
    escalate_to_human "No fix available for $package vulnerability"
  fi
done

# Verify all critical/high vulnerabilities patched
pnpm audit --audit-level=high
```

### 4. Verification Tests

After each fix attempt, run comprehensive verification:

```bash
# Stage 1: Quick Checks (< 1 minute)
echo "Stage 1: Quick checks..."
pnpm lint
if [ $? -ne 0 ]; then
  echo "âŒ Lint check failed"
  exit 1
fi

pnpm type-check
if [ $? -ne 0 ]; then
  echo "âŒ Type check failed"
  exit 1
fi

# Stage 2: Unit Tests (< 5 minutes)
echo "Stage 2: Unit tests..."
pnpm test
if [ $? -ne 0 ]; then
  echo "âŒ Unit tests failed"
  exit 1
fi

# Stage 3: Build Verification (< 2 minutes)
echo "Stage 3: Build..."
pnpm build
if [ $? -ne 0 ]; then
  echo "âŒ Build failed"
  exit 1
fi

# Stage 4: E2E Tests (< 10 minutes) - Optional for minor fixes
if [ "$RUN_E2E" = "true" ]; then
  echo "Stage 4: E2E tests..."
  pnpm test:e2e
  if [ $? -ne 0 ]; then
    echo "âŒ E2E tests failed"
    exit 1
  fi
fi

echo "âœ… All verification tests passed"
```

### 5. Rollback on Failure

If fix breaks other things:

```bash
# Automatic rollback
rollback_changes() {
  echo "Rolling back changes..."

  # Unstage all changes
  git reset HEAD .

  # Discard working directory changes
  git checkout -- .

  # Remove untracked files
  git clean -fd

  echo "âœ… Rollback complete"
}

# Verify rollback successful
pnpm test
pnpm build
```

### 6. Success Logging

Track fix success in `.localclaude/history.jsonl`:

```json
{
  "timestamp": "2025-11-10T11:30:00Z",
  "type": "error_fix_loop",
  "status": "success",
  "data": {
    "error_type": "lint",
    "error_count": 5,
    "attempts": 1,
    "fix_strategy": "eslint --fix",
    "verification": {
      "lint": "pass",
      "typecheck": "pass",
      "tests": "pass",
      "build": "pass"
    },
    "commit": "abc123",
    "duration_seconds": 45
  }
}
```

### 7. Escalation to Human

If max attempts reached or error not auto-fixable:

#### Create GitHub Issue
```bash
gh issue create \
  --title "ğŸ”´ Auto-Fix Failed: $ERROR_TYPE" \
  --body "**Error Type:** $ERROR_TYPE
**Attempts:** $ATTEMPT_COUNT / $MAX_ATTEMPTS
**Last Attempt:** $LAST_FIX_STRATEGY

**Error Details:**
\`\`\`
$ERROR_MESSAGE
\`\`\`

**Attempted Fixes:**
1. $FIX_1 (failed: $REASON_1)
2. $FIX_2 (failed: $REASON_2)
3. $FIX_3 (failed: $REASON_3)

**Verification Logs:**
See .localclaude/fix-loop-$TIMESTAMP.log

**Next Steps:**
- [ ] Manual investigation required
- [ ] Review error logs
- [ ] Implement custom fix
- [ ] Update fix strategies to handle this case

**Context:**
- Branch: $CURRENT_BRANCH
- Last commit: $LAST_COMMIT
- Triggered by: $TRIGGER_WORKFLOW

ğŸ¤– Escalated by Cline Caretaker (Error Fix Loop)" \
  --label "P0,auto-fix-failed,needs-manual-intervention" \
  --assignee ""
```

#### Notify in History
```json
{
  "timestamp": "2025-11-10T11:45:00Z",
  "type": "error_fix_loop",
  "status": "escalated",
  "data": {
    "error_type": "test_failure",
    "error_count": 2,
    "attempts": 5,
    "fix_strategies_tried": [
      "increase_timeout",
      "update_snapshots",
      "mock_reset",
      "test_isolation",
      "dependency_update"
    ],
    "escalation_reason": "Max attempts reached without resolution",
    "issue_url": "https://github.com/.../issues/234"
  }
}
```

### 8. Learning from Fixes

Update `.localclaude/memory.json` with successful fix patterns:

```json
{
  "fix_patterns": [
    {
      "error_type": "lint",
      "pattern": "Unsafe use of 'any' type",
      "successful_fix": "Replace 'any' with proper type or 'unknown'",
      "success_rate": 0.95,
      "examples": [
        {
          "before": "const data: any = response.data;",
          "after": "const data: unknown = response.data;"
        }
      ]
    },
    {
      "error_type": "test_failure",
      "pattern": "Timeout of 5000ms exceeded",
      "successful_fix": "Increase timeout to 10000ms for slow operations",
      "success_rate": 0.87,
      "examples": [
        {
          "before": "test('slow operation', async () => { ... }, 5000)",
          "after": "test('slow operation', async () => { ... }, 10000)"
        }
      ]
    }
  ]
}
```

## Fix Strategy Decision Tree

```
Error detected
    â”‚
    â”œâ”€ Is it auto-fixable? (lint, format)
    â”‚   â”œâ”€ YES â†’ Apply auto-fix â†’ Verify â†’ Done
    â”‚   â””â”€ NO â†’ Continue
    â”‚
    â”œâ”€ Is it semi-auto? (simple type errors, timeouts)
    â”‚   â”œâ”€ YES â†’ Attempt pattern-based fix â†’ Verify
    â”‚   â”‚         â””â”€ Success? â†’ Done
    â”‚   â”‚         â””â”€ Failure? â†’ Try next pattern (max 5 attempts)
    â”‚   â””â”€ NO â†’ Continue
    â”‚
    â”œâ”€ Is it a known pattern? (check memory.json)
    â”‚   â”œâ”€ YES â†’ Apply known fix â†’ Verify
    â”‚   â”‚         â””â”€ Success? â†’ Update success rate â†’ Done
    â”‚   â”‚         â””â”€ Failure? â†’ Mark pattern as failed â†’ Continue
    â”‚   â””â”€ NO â†’ Continue
    â”‚
    â””â”€ Manual intervention required
        â””â”€ Create GitHub issue
        â””â”€ Log escalation
        â””â”€ Notify team
```

## Expected Outputs

### Console Summary (Success)
```
=== Justice Companion Error Fix Loop ===
Date: 2025-11-10 11:30:00

ğŸ” Errors Detected: 8
  - 5 lint errors
  - 3 type errors
  - 0 test failures

ğŸ”§ Fix Attempts:
  âœ… Lint errors: Fixed (1 attempt, eslint --fix)
  âœ… Type errors: Fixed (2 attempts, added missing types)

âœ”ï¸ Verification:
  âœ… Lint: PASS
  âœ… Type Check: PASS
  âœ… Tests: PASS (1170/1170)
  âœ… Build: PASS

ğŸ“Š Fix Summary:
  - Total errors: 8
  - Auto-fixed: 8
  - Escalated: 0
  - Success rate: 100%
  - Duration: 3m 45s

ğŸ“ Commit: abc123
  Message: "chore: auto-fix lint and type errors"

Next: Run Quality Gate Check to verify all gates pass

Full log: .localclaude/fix-loop-2025-11-10-113000.log
```

### Console Summary (Partial Success)
```
=== Justice Companion Error Fix Loop ===
Date: 2025-11-10 11:45:00

ğŸ” Errors Detected: 12
  - 5 lint errors
  - 3 type errors
  - 2 test failures
  - 2 build errors

ğŸ”§ Fix Attempts:
  âœ… Lint errors: Fixed (1 attempt, eslint --fix)
  âœ… Type errors: Fixed (2 attempts, added missing types)
  âŒ Test failures: FAILED after 5 attempts
  âŒ Build errors: FAILED after 3 attempts

âœ”ï¸ Partial Verification:
  âœ… Lint: PASS
  âœ… Type Check: PASS
  âŒ Tests: FAIL (1168/1170, 2 failing)
  âŒ Build: FAIL

ğŸ“Š Fix Summary:
  - Total errors: 12
  - Auto-fixed: 8
  - Escalated: 4
  - Success rate: 67%
  - Duration: 8m 12s

ğŸš¨ Escalated Issues:
  - #234: Test failures in AuthService.test.ts
  - #235: Build errors in database.ts

ğŸ“ Commit: abc123 (partial fix)
  Message: "chore: auto-fix lint and type errors (partial)"

âš ï¸ Manual intervention required for escalated issues

Full log: .localclaude/fix-loop-2025-11-10-114500.log
```

## Integration with Other Workflows

### Triggered By:
- **Quality Gate Check** - If gates fail, trigger fix loop
- **Daily Status Sweep** - If errors detected, trigger fix loop
- **Maintenance Review** - For technical debt cleanup

### Triggers:
- **Quality Gate Check** - Re-run after fixes applied
- **Documentation Stewardship** - If fix changes APIs

## Automation Hooks

### Git Pre-Commit Hook
```bash
#!/bin/bash
echo "Running pre-commit fix loop..."

# Auto-fix lint errors
pnpm lint:fix

# Stage fixed files
git add .

echo "âœ… Auto-fixes applied"
```

### GitHub Actions Integration
```yaml
name: Auto Fix Loop
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
      - run: pnpm install

      # Run fix loop
      - run: pnpm lint:fix
      - run: pnpm type-check || true
      - run: pnpm test || true

      # Commit fixes if any
      - run: |
          if [[ `git status --porcelain` ]]; then
            git config user.name "Cline Caretaker"
            git config user.email "cline@example.com"
            git add .
            git commit -m "chore: auto-fix errors"
            git push
          fi
```

### Cron Job (Run After Daily Sweep)
```bash
# Add to crontab (every 6 hours)
0 */6 * * * cd /path/to/Justice-Companion && cline run "Error Fix Loop"
```

## Configuration

### `.localclaude/fix-loop-config.json`
```json
{
  "max_attempts": 5,
  "auto_commit": true,
  "auto_push": false,
  "escalate_after_attempts": 5,
  "verification_tests": {
    "lint": true,
    "typecheck": true,
    "unit_tests": true,
    "e2e_tests": false,
    "build": true
  },
  "fix_strategies": {
    "lint": ["eslint --fix"],
    "typecheck": ["add_types", "add_assertions", "ts-expect-error"],
    "test_failure": ["increase_timeout", "update_snapshots", "mock_reset"],
    "build_failure": ["fix_imports", "install_deps", "clear_cache"],
    "security": ["update_package", "find_alternative"]
  },
  "rollback_on_failure": true,
  "create_issues_on_escalation": true
}
```

## Success Criteria
- âœ“ Errors detected and categorized
- âœ“ Fix strategies applied systematically
- âœ“ Verification tests run after each fix
- âœ“ Rollback on failure
- âœ“ Success logged to history
- âœ“ Escalation when max attempts reached
- âœ“ Learning patterns stored in memory

## Run Frequency
**On-Demand** or **Automatic** after Quality Gate Check failures

## Related Workflows
- "Quality Gate Check" (triggers this workflow on failures)
- "Daily Status Sweep" (can trigger for accumulated errors)
- "Maintenance Backlog Review" (uses this for tech debt cleanup)
