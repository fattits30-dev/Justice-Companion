name: Release Pipeline

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v1.2.3-beta.1)

env:
  NODE_VERSION: '20.18.0'
  PNPM_VERSION: '10.18.3'

jobs:
  # Build release artifacts for all platforms
  build-release:
    name: Build Release - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 40

    strategy:
      matrix:
        include:
          - os: windows-latest
            platform: win
            artifact: '*.exe'
          - os: macos-latest
            platform: mac
            artifact: '*.dmg'
          - os: ubuntu-latest
            platform: linux
            artifact: '*.{AppImage,deb}'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Electron app for ${{ matrix.platform }}
        run: pnpm build:${{ matrix.platform }}
        env:
          CI: true

      # Verify build artifacts exist
      - name: Verify build artifacts
        run: |
          if [ ! -d "release" ]; then
            echo "âŒ Release directory not found"
            exit 1
          fi
          ls -lh release/
        shell: bash

      # Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.platform }}
          path: release/${{ matrix.artifact }}
          retention-days: 14

  # Create GitHub release with all artifacts
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build-release]
    timeout-minutes: 10

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Download all platform artifacts
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-win
          path: release/

      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-mac
          path: release/

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-linux
          path: release/

      # Generate changelog
      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "First release"
            CHANGELOG="Initial release"
          else
            CHANGELOG=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Extract version from tag
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # Create release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Justice Companion v${{ steps.version.outputs.version }}
          body: |
            ## Justice Companion v${{ steps.version.outputs.version }}

            ### ðŸ“¦ Installation

            **Windows:**
            - Download `Justice-Companion-Setup-${{ steps.version.outputs.version }}.exe`
            - Run the installer

            **macOS:**
            - Download `Justice-Companion-${{ steps.version.outputs.version }}.dmg`
            - Open and drag to Applications folder

            **Linux:**
            - **AppImage**: Download and run
            - **Debian/Ubuntu**: Download and install `.deb` file

            ### ðŸ“‹ Changelog

            ${{ steps.changelog.outputs.changelog }}

            ---

            **Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.changelog.outputs.previous_tag }}...${{ github.ref_name }}
          files: |
            release/*.exe
            release/*.dmg
            release/*.AppImage
            release/*.deb
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Generate SHA256 checksums
      - name: Generate checksums
        run: |
          cd release
          sha256sum * > SHA256SUMS.txt || true
          cat SHA256SUMS.txt || true

      - name: Upload checksums
        uses: softprops/action-gh-release@v1
        with:
          files: release/SHA256SUMS.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true
