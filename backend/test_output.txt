============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-7.4.4, pluggy-1.6.0 -- C:\Users\sava6\AppData\Local\Programs\Python\Python311\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend
plugins: mock-3.12.0, anyio-4.11.0, asyncio-0.23.3
asyncio: mode=Mode.STRICT
collecting ... collected 1 item

tests/services/backup/test_backup_scheduler.py::test_update_backup_settings_create_new FAILED [100%]

================================== FAILURES ===================================
___________________ test_update_backup_settings_create_new ____________________

backup_scheduler = <backend.services.backup.backup_scheduler.BackupScheduler object at 0x0000027D3B7A2B50>
test_user = <User(id=1, username='testuser', role='user')>
mock_audit_logger = <Mock id='2736892029264'>

    def test_update_backup_settings_create_new(backup_scheduler, test_user, mock_audit_logger):
        """Test creating new backup settings."""
        input_data = BackupSettingsUpdate(
            enabled=True,
            frequency=BackupFrequency.DAILY,
            backup_time="04:00",
            keep_count=10
        )
    
>       result = backup_scheduler.update_backup_settings(test_user.id, input_data)

tests\services\backup\test_backup_scheduler.py:326: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <backend.services.backup.backup_scheduler.BackupScheduler object at 0x0000027D3B7A2B50>
user_id = 1
input_data = BackupSettingsUpdate(enabled=True, frequency='daily', backup_time='04:00', keep_count=10)

    def update_backup_settings(
        self, user_id: int, input_data: BackupSettingsUpdate
    ) -> BackupSettingsResponse:
        """
        Update or create backup settings for a user.
    
        Args:
            user_id: User ID
            input_data: Updated backup settings
    
        Returns:
            Updated backup settings
    
        Raises:
            Exception: If database operation fails
        """
        try:
            # Check if settings exist
            existing = (
                self.db.query(BackupSettings).filter(BackupSettings.user_id == user_id).first()
            )
    
            now = datetime.utcnow()
    
            if existing:
                # Update existing settings
                if input_data.enabled is not None:
                    existing.enabled = input_data.enabled
    
                if input_data.frequency is not None:
                    existing.frequency = input_data.frequency.value
    
                if input_data.backup_time is not None:
                    existing.backup_time = input_data.backup_time
    
                if input_data.keep_count is not None:
                    existing.keep_count = input_data.keep_count
    
                # Recalculate next backup time if enabled
                if existing.enabled:
                    existing.next_backup_at = self._calculate_next_backup_time(
                        existing.frequency, existing.backup_time
                    )
                else:
                    existing.next_backup_at = None
    
                existing.updated_at = now
    
                self.db.commit()
                self.db.refresh(existing)
    
                logger.info(f"Updated backup settings for user {user_id}")
    
                self._log_audit(
                    event_type="backup_scheduler.settings_updated",
                    user_id=user_id,
                    resource_id=str(existing.id),
                    action="update",
                    success=True,
                )
    
                return BackupSettingsResponse.model_validate(existing)
    
            else:
                # Create new settings with defaults
                new_settings = BackupSettings(
                    user_id=user_id,
                    enabled=input_data.enabled if input_data.enabled is not None else True,
                    frequency=(
>                       input_data.frequency.value
                        if input_data.frequency
                        else BackupFrequency.DAILY.value
                    ),
                    backup_time=input_data.backup_time if input_data.backup_time else "03:00",
                    keep_count=input_data.keep_count if input_data.keep_count is not None else 7,
                    created_at=now,
                    updated_at=now,
                )
E               AttributeError: 'str' object has no attribute 'value'

services\backup\backup_scheduler.py:495: AttributeError
---------------------------- Captured stdout setup ----------------------------
2025-11-30 04:33:34,767 - backend.services.backup.backup_scheduler - INFO - BackupScheduler initialized with check_interval=1s
----------------------------- Captured log setup ------------------------------
INFO     backend.services.backup.backup_scheduler:backup_scheduler.py:101 BackupScheduler initialized with check_interval=1s
---------------------------- Captured stdout call -----------------------------
2025-11-30 04:33:34,807 - backend.services.backup.backup_scheduler - ERROR - Error updating backup settings: 'str' object has no attribute 'value'
Traceback (most recent call last):
  File "C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\services\backup\backup_scheduler.py", line 495, in update_backup_settings
    input_data.frequency.value
AttributeError: 'str' object has no attribute 'value'
------------------------------ Captured log call ------------------------------
ERROR    backend.services.backup.backup_scheduler:backup_scheduler.py:530 Error updating backup settings: 'str' object has no attribute 'value'
Traceback (most recent call last):
  File "C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\services\backup\backup_scheduler.py", line 495, in update_backup_settings
    input_data.frequency.value
AttributeError: 'str' object has no attribute 'value'
============================== warnings summary ===============================
services\ai\providers.py:105
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\services\ai\providers.py:105: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AIProviderConfigOutput(BaseModel):

..\..\..\..\AppData\Local\Programs\Python\Python311\Lib\site-packages\pydantic\_internal\_config.py:383
  C:\Users\sava6\AppData\Local\Programs\Python\Python311\Lib\site-packages\pydantic\_internal\_config.py:383: UserWarning: Valid config keys have changed in V2:
  * 'orm_mode' has been renamed to 'from_attributes'
    warnings.warn(message, UserWarning)

services\ai\providers.py:125
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\services\ai\providers.py:125: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class AIProviderConfigSummary(BaseModel):

services\document_parser_service.py:56
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\services\document_parser_service.py:56: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ParsedDocumentMetadata(BaseModel):

routes\export.py:97
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\routes\export.py:97: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ExportResult(BaseModel):

routes\export.py:123
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\routes\export.py:123: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ExportTemplate(BaseModel):

routes\profile.py:196
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\routes\profile.py:196: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class ProfileResponse(BaseModel):

routes\ui.py:85
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\routes\ui.py:85: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OpenDialogRequest(BaseModel):

routes\ui.py:111
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\routes\ui.py:111: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SaveDialogRequest(BaseModel):

routes\ui.py:139
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\routes\ui.py:139: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class OpenDialogResponse(BaseModel):

routes\ui.py:152
  C:\Users\sava6\ClaudeHome\projects\Justice Companion\backend\routes\ui.py:152: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class SaveDialogResponse(BaseModel):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/services/backup/test_backup_scheduler.py::test_update_backup_settings_create_new
======================= 1 failed, 11 warnings in 0.44s ========================
